# ==================================================================
# NGINX MAIN CONFIGURATION FOR REVELO IMAGE GALLERY APPLICATION
# ==================================================================
# This is the main nginx configuration that defines global settings
# for handling web traffic, security, performance, and rate limiting.

# User that nginx worker processes run as (security)
user nginx;

# Number of worker processes - 'auto' means one per CPU core
# This allows nginx to handle multiple connections simultaneously
worker_processes auto;

# Where to log errors and at what level (debug, info, notice, warn, error, crit)
error_log /var/log/nginx/error.log notice;

# File where the main process ID is stored (for process management)
pid /var/run/nginx.pid;

# ==================================================================
# EVENTS BLOCK - CONNECTION HANDLING CONFIGURATION
# ==================================================================
events {
    # Maximum number of simultaneous connections per worker process
    # Total connections = worker_processes × worker_connections
    worker_connections 1024;
    
    # Use epoll for better performance on Linux (efficient I/O event handling)
    use epoll;
    
    # Allow worker to accept multiple connections at once (performance boost)
    multi_accept on;
}

# ==================================================================
# HTTP BLOCK - MAIN WEB SERVER CONFIGURATION
# ==================================================================
http {
    # Include MIME type definitions (tells nginx how to handle different file types)
    # This file maps file extensions to content types (e.g., .jpg → image/jpeg)
    include /etc/nginx/mime.types;
    
    # Default content type when nginx can't determine the file type
    default_type application/octet-stream;

    # ==================================================================
    # LOGGING CONFIGURATION
    # ==================================================================
    # Define custom log format with useful information for debugging
    # $remote_addr = visitor's IP address
    # $remote_user = authenticated username (if using HTTP auth)
    # $time_local = timestamp in local timezone
    # $request = HTTP method, path, and protocol version
    # $status = HTTP response code (200, 404, 500, etc.)
    # $body_bytes_sent = size of response body
    # $http_referer = page that linked to this request
    # $http_user_agent = browser/client information
    # $http_x_forwarded_for = real client IP when behind a proxy
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    # Enable access logging with our custom format
    access_log /var/log/nginx/access.log main;

    # ==================================================================
    # PERFORMANCE OPTIMIZATIONS
    # ==================================================================
    # Use sendfile() system call for efficient file serving
    # This allows the kernel to serve files directly without copying to userspace
    sendfile on;
    
    # Send headers and beginning of file in one packet (reduces network overhead)
    tcp_nopush on;
    
    # Don't buffer small writes (reduces latency for dynamic content)
    tcp_nodelay on;
    
    # How long to keep connections alive (65 seconds is a good balance)
    keepalive_timeout 65;
    
    # Increase hash table size for better performance with many MIME types
    types_hash_max_size 2048;
    
    # Maximum size of request body (important for file uploads)
    # 500M allows uploading very large images and multiple files
    client_max_body_size 500M;

    # ==================================================================
    # GZIP COMPRESSION CONFIGURATION
    # ==================================================================
    # Enable gzip compression to reduce bandwidth usage
    gzip on;
    
    # Add "Vary: Accept-Encoding" header (tells caches about compression)
    gzip_vary on;
    
    # Only compress files larger than 1KB (smaller files aren't worth compressing)
    gzip_min_length 1024;
    
    # Compress responses for all proxy requests
    gzip_proxied any;
    
    # Compression level (1-9, where 6 is good balance of speed vs compression)
    gzip_comp_level 6;
    
    # File types to compress (images and videos are already compressed, so skip them)
    gzip_types
        text/plain          # Plain text files
        text/css            # Stylesheets
        text/xml            # XML files
        text/javascript     # JavaScript files
        application/json    # API responses
        application/javascript
        application/xml+rss # RSS feeds
        application/atom+xml # Atom feeds
        image/svg+xml;      # SVG images (these can be compressed)

    # ==================================================================
    # SECURITY HEADERS
    # ==================================================================
    # Prevent MIME type sniffing (stops browsers from guessing content types)
    add_header X-Content-Type-Options nosniff always;
    # Enable XSS protection in browsers (legacy, but doesn't hurt)
    add_header X-XSS-Protection "1; mode=block" always;
    # Control what referrer information is sent (privacy protection)
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ==================================================================
    # RATE LIMITING CONFIGURATION
    # ==================================================================
    # Rate limiting protects against abuse and DoS attacks
    # It limits how many requests a single IP can make per second
    
    # API rate limit: 100 requests per second per IP (increased for image gallery)
    # zone=api = name of this rate limit zone
    # 10m = memory allocated for tracking IPs (can handle ~160k IPs)
    # rate=100r/s = maximum 100 requests per second per IP
    limit_req_zone $binary_remote_addr zone=api:10m rate=100r/s;

    # Upload rate limit: 50 requests per second per IP
    # Higher limit for uploads to handle multiple image uploads
    limit_req_zone $binary_remote_addr zone=uploads:10m rate=50r/s;

    # ==================================================================
    # INCLUDE SITE-SPECIFIC CONFIGURATIONS
    # ==================================================================
    # Load all .conf files from the conf.d directory
    # This is where our main site configuration (default.conf) is loaded
    include /etc/nginx/conf.d/*.conf;
}